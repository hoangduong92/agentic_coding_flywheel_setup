#!/usr/bin/env bash
# ACFS Pre-commit Hook: Auto-regenerate manifest outputs + chain to beads
#
# This hook does TWO things:
# 1. When acfs.manifest.yaml or packages/manifest/** change,
#    regenerates scripts/generated/** and stages the changes.
# 2. Chains to beads pre-commit hook if bd is installed.
#
# Install: ./scripts/hooks/install.sh
# Bypass: git commit --no-verify
# CI enforces: bun run generate --diff (blocks merge on drift)

set -euo pipefail

# ============================================================
# ACFS Manifest Regeneration
# ============================================================

# Check if manifest-related files are staged
if git diff --cached --name-only | grep -qE '^(acfs\.manifest\.yaml|packages/manifest/)'; then
    echo "ðŸ“¦ Manifest changes detected, regenerating scripts/generated/..."

    # Check if bun is available
    if ! command -v bun &>/dev/null; then
        echo "âš ï¸  bun not found. Skipping auto-regeneration."
        echo "   Run manually: cd packages/manifest && bun run generate"
        # Don't exit - let the commit proceed, CI will catch drift
    else
        # Regenerate
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

        if (cd "$REPO_ROOT/packages/manifest" && bun install --silent && bun run generate); then
            # Stage regenerated files
            git add "$REPO_ROOT/scripts/generated/"
            echo "âœ… Regenerated and staged scripts/generated/"
        else
            echo "âŒ Generator failed. Fix issues before committing."
            exit 1
        fi
    fi
fi

# ============================================================
# Chain to beads (bd) pre-commit hook if available
# ============================================================

if command -v bd >/dev/null 2>&1; then
    # bd hooks run will execute beads-specific pre-commit logic
    exec bd hooks run pre-commit "$@"
fi

# No beads, and ACFS checks passed - allow commit
exit 0
